# Migration Guide: v0.1.4 â†’ v0.1.5

> **Loom Agent v0.1.5 Migration Guide**
> ä» v0.1.4 å‡çº§åˆ° v0.1.5 çš„å®Œæ•´æŒ‡å—

---

## ç›®å½•

1. [ç‰ˆæœ¬æ¦‚è¿°](#ç‰ˆæœ¬æ¦‚è¿°)
2. [é‡å¤§å˜æ›´](#é‡å¤§å˜æ›´)
3. [æ–°ç‰¹æ€§](#æ–°ç‰¹æ€§)
4. [è¿ç§»æ­¥éª¤](#è¿ç§»æ­¥éª¤)
5. [å¸¸è§è¿ç§»åœºæ™¯](#å¸¸è§è¿ç§»åœºæ™¯)
6. [å‘åå…¼å®¹æ€§](#å‘åå…¼å®¹æ€§)
7. [FAQ](#faq)

---

## ç‰ˆæœ¬æ¦‚è¿°

### v0.1.5 å¸¦æ¥äº†ä»€ä¹ˆï¼Ÿ

v0.1.5 æ˜¯ä¸€ä¸ª**å¢å¼ºç‰ˆæœ¬**ï¼Œä¸“æ³¨äºæå‡ Agent ç¼–æ’èƒ½åŠ›ï¼š

âœ… **æ–°å¢ Message Protocol** - ç»“æ„åŒ–æ¶ˆæ¯ä¼ é€’ï¼Œæ›¿ä»£çº¯å­—ç¬¦ä¸²
âœ… **æ–°å¢ Pipeline æ¨¡å¼** - é¡ºåºå’Œå¹¶è¡Œç¼–æ’å¤šä¸ª Agent
âœ… **å®Œå…¨å‘åå…¼å®¹** - æ‰€æœ‰æ—§ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ
âœ… **æ€§èƒ½ä¼˜åŒ–** - Message åˆ›å»º 440k+ msg/sï¼Œå¹¶è¡ŒåŠ é€Ÿè¿‘ 3x

### å‡çº§å»ºè®®

- â­ **æ¨èå‡çº§**: æ‰€æœ‰ç”¨æˆ·éƒ½å»ºè®®å‡çº§åˆ° v0.1.5
- â±ï¸ **å‡çº§æ—¶é—´**: 5-30 åˆ†é’Ÿï¼ˆå–å†³äºä»£ç å¤æ‚åº¦ï¼‰
- ğŸ”„ **å…¼å®¹æ€§**: 100% å‘åå…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´

---

## é‡å¤§å˜æ›´

### âš ï¸ æ— ç ´åæ€§å˜æ›´

v0.1.5 **å®Œå…¨å‘åå…¼å®¹** v0.1.4ï¼Œæ‰€æœ‰æ—§ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œã€‚

### æ–°å¢åŠŸèƒ½

1. **Message Protocol (loom.core.message_v2)**
   - æ–°å¢ `Message` ç±»
   - æ–°å¢ `BaseAgent.reply(message)` æ–¹æ³•
   - æ–°å¢ä¾¿æ·å‡½æ•°: `create_user_message()`, `create_assistant_message()`

2. **Pipeline æ¨¡å¼ (loom.patterns.pipeline)**
   - æ–°å¢ `SequentialPipeline` - é¡ºåºç¼–æ’
   - æ–°å¢ `ParallelPipeline` - å¹¶è¡Œç¼–æ’
   - æ–°å¢ä¾¿æ·å‡½æ•°: `sequential()`, `parallel()`

3. **BaseAgent å¢å¼º**
   - æ–°å¢ `reply(message: Message) -> Message` æ–¹æ³•
   - æ–°å¢ `reply_stream(message: Message)` æ–¹æ³•
   - ä¿ç•™åŸæœ‰ `run(str) -> str` æ–¹æ³•

---

## æ–°ç‰¹æ€§

### 1. Message Protocol

**ä¹‹å‰ (v0.1.4)**:
```python
# åªèƒ½ä½¿ç”¨å­—ç¬¦ä¸²
result = await agent.run("What is AI?")
```

**ç°åœ¨ (v0.1.5)**:
```python
# å¯ä»¥ä½¿ç”¨ç»“æ„åŒ–æ¶ˆæ¯
from loom.core.message_v2 import Message

msg = Message(role="user", content="What is AI?")
reply = await agent.reply(msg)

# è‡ªåŠ¨è¿½æº¯çˆ¶æ¶ˆæ¯
print(reply.parent_id == msg.id)  # True
```

**ä¼˜åŠ¿**:
- âœ… æ¶ˆæ¯è¿½æº¯ (parent_id)
- âœ… å…ƒæ•°æ®æ”¯æŒ
- âœ… æ›´å¥½çš„ç±»å‹å®‰å…¨
- âœ… ä¾¿äºåºåˆ—åŒ–å’ŒæŒä¹…åŒ–

### 2. Pipeline ç¼–æ’

**ä¹‹å‰ (v0.1.4)**:
```python
# æ‰‹åŠ¨ä¸²è”
result1 = await researcher.run(input)
result2 = await writer.run(result1)
result3 = await reviewer.run(result2)
```

**ç°åœ¨ (v0.1.5)**:
```python
# è‡ªåŠ¨ç¼–æ’
from loom.patterns import SequentialPipeline

pipeline = SequentialPipeline([researcher, writer, reviewer])
result = await pipeline.run(input)
```

**ä¼˜åŠ¿**:
- âœ… ä»£ç æ›´ç®€æ´
- âœ… æ›´æ˜“ç»´æŠ¤å’Œé‡ç”¨
- âœ… æ”¯æŒå¹¶è¡Œæ‰§è¡Œ
- âœ… ç»Ÿä¸€çš„ Agent æ¥å£

### 3. å¹¶è¡Œæ‰§è¡Œ

**v0.1.5 æ–°å¢**:
```python
from loom.patterns import ParallelPipeline

# å¤šä¸ªåˆ†æå¸ˆå¹¶è¡Œåˆ†æ
pipeline = ParallelPipeline([
    technical_analyst,
    business_analyst,
    user_analyst
])

# åŒæ—¶æ‰§è¡Œï¼ŒåŠ é€Ÿè¿‘ 3x
result = await pipeline.run("Analyze AI impact")
```

---

## è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1: æ›´æ–°ä¾èµ–

```bash
# å‡çº§ Loom Agent
pip install --upgrade loom-agent

# éªŒè¯ç‰ˆæœ¬
python -c "import loom; print(loom.__version__)"
# åº”è¯¥æ˜¾ç¤º: 0.1.5
```

### æ­¥éª¤ 2: æ— éœ€ä¿®æ”¹æ—§ä»£ç 

âœ… **å¥½æ¶ˆæ¯**: æ‰€æœ‰ v0.1.4 ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œï¼

```python
# v0.1.4 ä»£ç ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
import loom
from loom.builtin.llms import OpenAILLM

agent = loom.agent(name="assistant", llm=OpenAILLM())
result = await agent.run("Hello")  # âœ… ä»ç„¶å·¥ä½œ
```

### æ­¥éª¤ 3: é€æ­¥é‡‡ç”¨æ–°ç‰¹æ€§ï¼ˆå¯é€‰ï¼‰

æ ¹æ®éœ€è¦é€æ­¥é‡‡ç”¨æ–°ç‰¹æ€§ï¼Œæ— éœ€ä¸€æ¬¡æ€§é‡å†™æ‰€æœ‰ä»£ç ã€‚

---

## å¸¸è§è¿ç§»åœºæ™¯

### åœºæ™¯ 1: ç®€å• Agent ä½¿ç”¨

**v0.1.4**:
```python
import loom
from loom.builtin.llms import OpenAILLM

agent = loom.agent(name="assistant", llm=OpenAILLM(model="gpt-4"))
result = await agent.run("What is Python?")
print(result)
```

**v0.1.5 (æ— éœ€ä¿®æ”¹)**:
```python
# å®Œå…¨ç›¸åŒçš„ä»£ç ä»ç„¶å·¥ä½œ
import loom
from loom.builtin.llms import OpenAILLM

agent = loom.agent(name="assistant", llm=OpenAILLM(model="gpt-4"))
result = await agent.run("What is Python?")
print(result)
```

**v0.1.5 (å¯é€‰ï¼šä½¿ç”¨ Message)**:
```python
import loom
from loom.builtin.llms import OpenAILLM
from loom.core.message_v2 import create_user_message

agent = loom.agent(name="assistant", llm=OpenAILLM(model="gpt-4"))

# ä½¿ç”¨ Message æ¥å£
msg = create_user_message("What is Python?")
reply = await agent.reply(msg)

print(reply.content)
print(f"Reply ID: {reply.id}")
print(f"Parent ID: {reply.parent_id}")
```

### åœºæ™¯ 2: å¤šä¸ª Agent ä¸²è”

**v0.1.4**:
```python
# æ‰‹åŠ¨ä¸²è”
researcher = loom.agent(name="researcher", llm=llm)
writer = loom.agent(name="writer", llm=llm)
reviewer = loom.agent(name="reviewer", llm=llm)

# æ‰‹åŠ¨æ‰§è¡Œæ¯ä¸€æ­¥
result1 = await researcher.run("Research quantum computing")
result2 = await writer.run(result1)
final = await reviewer.run(result2)
```

**v0.1.5 (æ¨èï¼šä½¿ç”¨ Pipeline)**:
```python
from loom.patterns import SequentialPipeline

researcher = loom.agent(name="researcher", llm=llm)
writer = loom.agent(name="writer", llm=llm)
reviewer = loom.agent(name="reviewer", llm=llm)

# ä½¿ç”¨ Pipeline è‡ªåŠ¨ä¸²è”
pipeline = SequentialPipeline([researcher, writer, reviewer])
final = await pipeline.run("Research quantum computing")
```

### åœºæ™¯ 3: å¹¶è¡Œå¤„ç†

**v0.1.4**:
```python
import asyncio

# æ‰‹åŠ¨å¹¶è¡Œæ‰§è¡Œ
analyst1 = loom.agent(name="technical", llm=llm)
analyst2 = loom.agent(name="business", llm=llm)
analyst3 = loom.agent(name="user", llm=llm)

# ä½¿ç”¨ asyncio.gather
results = await asyncio.gather(
    analyst1.run(input),
    analyst2.run(input),
    analyst3.run(input)
)

# æ‰‹åŠ¨åˆå¹¶ç»“æœ
combined = "\n\n".join(results)
```

**v0.1.5 (æ¨èï¼šä½¿ç”¨ ParallelPipeline)**:
```python
from loom.patterns import ParallelPipeline

analyst1 = loom.agent(name="technical", llm=llm)
analyst2 = loom.agent(name="business", llm=llm)
analyst3 = loom.agent(name="user", llm=llm)

# ä½¿ç”¨ Pipeline è‡ªåŠ¨å¹¶è¡Œ
pipeline = ParallelPipeline([analyst1, analyst2, analyst3])
combined = await pipeline.run(input)
```

### åœºæ™¯ 4: å¤šè½®å¯¹è¯

**v0.1.4**:
```python
# æ²¡æœ‰å†…ç½®çš„å¯¹è¯è¿½æº¯
agent = loom.agent(name="chatbot", llm=llm)

result1 = await agent.run("My name is Alice")
result2 = await agent.run("What's my name?")
# é—®é¢˜ï¼šAgent å¯èƒ½ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯
```

**v0.1.5 (ä½¿ç”¨ Message è¿½æº¯)**:
```python
from loom.core.message_v2 import Message

agent = loom.agent(name="chatbot", llm=llm)

# ç¬¬ä¸€è½®
msg1 = Message(role="user", content="My name is Alice")
reply1 = await agent.reply(msg1)

# ç¬¬äºŒè½®ï¼ˆåŸºäºç¬¬ä¸€è½®å›å¤ï¼‰
msg2 = reply1.reply("What's my name?", role="user")
reply2 = await agent.reply(msg2)

# Message é“¾ä¿ç•™äº†å¯¹è¯å†å²
print(reply2.parent_id == msg2.id)  # True
```

### åœºæ™¯ 5: ReActAgent ä½¿ç”¨

**v0.1.4**:
```python
from loom.agents import ReActAgent
from loom.builtin.tools import Calculator

agent = ReActAgent(
    name="solver",
    llm=llm,
    tools=[Calculator()]
)

result = await agent.run("What is 25 * 48?")
```

**v0.1.5 (æ— éœ€ä¿®æ”¹)**:
```python
# å®Œå…¨ç›¸åŒçš„ä»£ç ä»ç„¶å·¥ä½œ
from loom.agents import ReActAgent
from loom.builtin.tools import Calculator

agent = ReActAgent(
    name="solver",
    llm=llm,
    tools=[Calculator()]
)

result = await agent.run("What is 25 * 48?")
```

**v0.1.5 (å¯é€‰ï¼šåœ¨ Pipeline ä¸­ä½¿ç”¨)**:
```python
from loom.patterns import SequentialPipeline

# ReActAgent å¯ä»¥å’Œå…¶ä»– Agent ç»„åˆ
researcher = ReActAgent(name="researcher", llm=llm, tools=[search_tool])
writer = loom.agent(name="writer", llm=llm)

pipeline = SequentialPipeline([researcher, writer])
result = await pipeline.run("Research and write about AI")
```

---

## å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹çš„åŠŸèƒ½

ä»¥ä¸‹ v0.1.4 åŠŸèƒ½åœ¨ v0.1.5 ä¸­**å®Œå…¨ä¸å˜**ï¼š

- âœ… `SimpleAgent`
- âœ… `ReActAgent`
- âœ… `agent.run(str) -> str`
- âœ… `agent.run_stream(str)`
- âœ… æ‰€æœ‰ LLM å®ç° (`OpenAILLM`, `AnthropicLLM` ç­‰)
- âœ… æ‰€æœ‰å·¥å…· (`Calculator`, `SearchTool` ç­‰)
- âœ… å·¥å…·æ³¨å†Œå’Œè°ƒç”¨æœºåˆ¶

### ğŸ†• æ–°å¢çš„åŠŸèƒ½

ä»¥ä¸‹æ˜¯ v0.1.5 **æ–°å¢** çš„åŠŸèƒ½ï¼š

- ğŸ†• `Message` ç±»
- ğŸ†• `agent.reply(message: Message) -> Message`
- ğŸ†• `SequentialPipeline`
- ğŸ†• `ParallelPipeline`
- ğŸ†• `sequential()`, `parallel()` ä¾¿æ·å‡½æ•°
- ğŸ†• æ¶ˆæ¯è¿½æº¯ (`parent_id`, `trace_message_chain`)

### æ··åˆä½¿ç”¨

ä½ å¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­**æ··åˆä½¿ç”¨** v0.1.4 å’Œ v0.1.5 çš„æ¥å£ï¼š

```python
# æ—§æ¥å£
result1 = await agent.run("Task 1")  # v0.1.4 é£æ ¼

# æ–°æ¥å£
msg = Message(role="user", content="Task 2")
reply = await agent.reply(msg)  # v0.1.5 é£æ ¼

# å†ç”¨æ—§æ¥å£
result3 = await agent.run("Task 3")  # ä»ç„¶å¯ä»¥
```

---

## FAQ

### Q1: å¿…é¡»ç«‹å³è¿ç§»åˆ° Message æ¥å£å—ï¼Ÿ

**A**: ä¸éœ€è¦ã€‚å­—ç¬¦ä¸²æ¥å£ (`run()`) ä»ç„¶å®Œå…¨æ”¯æŒï¼Œä½ å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚Message æ¥å£æ˜¯**å¯é€‰çš„**ï¼Œåªæœ‰åœ¨éœ€è¦æ¶ˆæ¯è¿½æº¯ã€å…ƒæ•°æ®ç­‰é«˜çº§åŠŸèƒ½æ—¶æ‰ä½¿ç”¨ã€‚

### Q2: Pipeline ç›¸æ¯”æ‰‹åŠ¨ä¸²è”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

**A**:
- âœ… ä»£ç æ›´ç®€æ´ã€æ˜“è¯»
- âœ… æ›´å®¹æ˜“é‡ç”¨å’Œç»„åˆ
- âœ… æ”¯æŒå¹¶è¡Œæ‰§è¡Œï¼ˆParallelPipelineï¼‰
- âœ… ç»Ÿä¸€çš„æ¥å£ï¼ˆPipeline æœ¬èº«ä¹Ÿæ˜¯ Agentï¼‰
- âœ… æœªæ¥æ”¯æŒæ›´é«˜çº§çš„ç¼–æ’æ¨¡å¼ï¼ˆåµŒå¥—ã€æ¡ä»¶ã€å¾ªç¯ç­‰ï¼‰

### Q3: æ€§èƒ½æœ‰å½±å“å—ï¼Ÿ

**A**: æ€§èƒ½å½±å“æå°ç”šè‡³æœ‰æå‡ï¼š
- Message åˆ›å»º: **440k+ msg/s**
- Pipeline å¼€é”€: **< 5%**
- å¹¶è¡ŒåŠ é€Ÿ: **è¿‘ 3x**ï¼ˆ3 ä¸ª Agentï¼‰

### Q4: æˆ‘çš„æ—§æµ‹è¯•ä¼šå¤±è´¥å—ï¼Ÿ

**A**: ä¸ä¼šã€‚æ‰€æœ‰ v0.1.4 çš„æµ‹è¯•åº”è¯¥åœ¨ v0.1.5 ä¸­æ— éœ€ä¿®æ”¹å³å¯é€šè¿‡ã€‚

### Q5: Message æ”¯æŒå¤šæ¨¡æ€ï¼ˆå›¾åƒã€éŸ³é¢‘ï¼‰å—ï¼Ÿ

**A**: v0.1.5 åªæ”¯æŒçº¯æ–‡æœ¬ã€‚å¤šæ¨¡æ€æ”¯æŒè®¡åˆ’åœ¨æœªæ¥ç‰ˆæœ¬ï¼ˆPhase 3+ï¼‰ä¸­æ·»åŠ ã€‚

### Q6: å¯ä»¥åµŒå¥— Pipeline å—ï¼Ÿ

**A**: v0.1.5 æš‚ä¸æ”¯æŒåµŒå¥—ã€‚åµŒå¥— Pipeline è®¡åˆ’åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æ”¯æŒã€‚

### Q7: å¦‚ä½•åœ¨ Pipeline ä¸­å¤„ç†é”™è¯¯ï¼Ÿ

**A**:
```python
try:
    result = await pipeline.run(input)
except Exception as e:
    print(f"Pipeline failed: {e}")
    # å®ç°é‡è¯•ã€å›é€€ç­‰é€»è¾‘
```

### Q8: Pipeline å¯ä»¥åŒ…å«ä¸åŒç±»å‹çš„ Agent å—ï¼Ÿ

**A**: å¯ä»¥ï¼ä»»ä½•ç»§æ‰¿è‡ª `BaseAgent` çš„ Agent éƒ½å¯ä»¥æ”¾å…¥ Pipelineï¼š

```python
import loom, ReActAgent

simple = loom.agent(name="simple", llm=llm)
react = ReActAgent(name="react", llm=llm, tools=[tool])

# æ··åˆä¸åŒç±»å‹
pipeline = SequentialPipeline([simple, react])
```

### Q9: å¦‚ä½•è‡ªå®šä¹‰ ParallelPipeline çš„èšåˆé€»è¾‘ï¼Ÿ

**A**:
```python
def custom_aggregator(results: List[str]) -> str:
    # è‡ªå®šä¹‰èšåˆé€»è¾‘
    return " | ".join(results)

pipeline = ParallelPipeline(
    [agent1, agent2, agent3],
    aggregator=custom_aggregator
)
```

### Q10: è¿ç§»é‡åˆ°é—®é¢˜æ€ä¹ˆåŠï¼Ÿ

**A**:
1. æŸ¥çœ‹æ–‡æ¡£: `docs/guides/message_protocol.md` å’Œ `docs/guides/pipeline_guide.md`
2. æŸ¥çœ‹ç¤ºä¾‹: `examples/` ç›®å½•ï¼ˆå³å°†æ·»åŠ ï¼‰
3. æäº¤ Issue: [GitHub Issues](https://github.com/your-org/loom-agent/issues)

---

## è¿ç§»æ£€æŸ¥æ¸…å•

ä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿è¿ç§»é¡ºåˆ©ï¼š

### åŸºç¡€å‡çº§
- [ ] å‡çº§åˆ° Loom Agent v0.1.5
- [ ] éªŒè¯æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰åºŸå¼ƒè­¦å‘Š

### å¯é€‰å¢å¼ºï¼ˆæ ¹æ®éœ€è¦ï¼‰
- [ ] è¯†åˆ«å¯ä»¥ä½¿ç”¨ Pipeline çš„æ‰‹åŠ¨ä¸²è”ä»£ç 
- [ ] å°†æ‰‹åŠ¨å¹¶è¡Œæ‰§è¡Œæ”¹ä¸º ParallelPipeline
- [ ] åœ¨éœ€è¦å¯¹è¯è¿½æº¯çš„åœ°æ–¹ä½¿ç”¨ Message
- [ ] æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Š

### æµ‹è¯•
- [ ] è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- [ ] æ·»åŠ æ–°ç‰¹æ€§çš„æµ‹è¯•ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### å‘å¸ƒ
- [ ] æ›´æ–°ç‰ˆæœ¬ä¾èµ–
- [ ] æ›´æ–° CHANGELOG
- [ ] éƒ¨ç½²æ–°ç‰ˆæœ¬

---

## è·å–å¸®åŠ©

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

- ğŸ“– **æ–‡æ¡£**: æŸ¥çœ‹ `docs/guides/` ä¸‹çš„è¯¦ç»†æŒ‡å—
- ğŸ’¬ **ç¤¾åŒº**: åŠ å…¥ Discord/Slack è®¨è®º
- ğŸ› **æŠ¥å‘Š Bug**: [GitHub Issues](https://github.com/your-org/loom-agent/issues)
- ğŸ“§ **è”ç³»**: support@loom-agent.dev

---

**ç‰ˆæœ¬**: v0.1.5
**æœ€åæ›´æ–°**: 2024-12-13
**ä¸‹ä¸€ç‰ˆæœ¬é¢„å‘Š**: Phase 3+ å°†æ”¯æŒåµŒå¥— Pipelineã€æ¡ä»¶åˆ†æ”¯ã€å¾ªç¯ç­‰é«˜çº§ç‰¹æ€§
