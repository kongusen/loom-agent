<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .trace-item:hover { background-color: #f3f4f6; cursor: pointer; }
        .active-trace { background-color: #e5e7eb; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">
    <div id="app" class="flex h-full">
        <!-- Sidebar: Trace List -->
        <div class="w-1/4 bg-white border-r flex flex-col">
            <div class="p-4 border-b bg-blue-600 text-white">
                <h1 class="text-xl font-bold">ðŸ§µ Loom Studio</h1>
            </div>
            <div class="p-2 border-b">
                <button @click="fetchTraces" class="w-full bg-blue-100 text-blue-700 py-1 px-3 rounded hover:bg-blue-200">
                    Refresh List
                </button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div v-for="trace in traces" :key="trace.id" 
                     @click="selectTrace(trace)"
                     class="p-4 border-b trace-item transition"
                     :class="{'active-trace': currentTrace && currentTrace.id === trace.id}">
                    <div class="font-bold truncate">{{ trace.name }}</div>
                    <div class="text-xs text-gray-500 flex justify-between mt-1">
                        <span>{{ formatDate(trace.start_time) }}</span>
                        <span :class="getStatusClass(trace.status)">{{ trace.status }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Trace Detail -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-white p-4 border-b shadow-sm flex justify-between items-center h-16">
                <div v-if="currentTrace">
                    <h2 class="text-lg font-bold">{{ currentTrace.name }}</h2>
                    <span class="text-xs text-gray-500">{{ currentTrace.id }}</span>
                </div>
                <div v-else class="text-gray-400">Select a trace to view details</div>
                
                <div v-if="currentTrace">
                   <button @click="refreshCurrentTrace" class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">
                       Refresh Events
                   </button>
                </div>
            </div>

            <!-- Events Timeline -->
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" v-if="currentTrace">
                <div class="max-w-4xl mx-auto">
                    <div v-for="(event, index) in currentTrace.events" :key="index" class="mb-4 flex gap-4">
                        <!-- Time -->
                        <div class="w-24 text-right text-xs text-gray-400 font-mono py-1">
                            {{ formatTime(event.timestamp) }}
                        </div>
                        
                        <!-- Connector -->
                        <div class="flex flex-col items-center">
                            <div class="w-3 h-3 rounded-full" :class="getEventColor(event.type)"></div>
                            <div class="w-0.5 bg-gray-200 flex-1 my-1" v-if="index < currentTrace.events.length - 1"></div>
                        </div>

                        <!-- Card -->
                        <div class="flex-1 bg-white rounded-lg shadow border border-gray-100 p-3 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="px-2 py-0.5 rounded text-xs font-mono font-bold uppercase" 
                                          :class="getEventBadgeClass(event.type)">
                                        {{ event.type }}
                                    </span>
                                    <span class="ml-2 font-bold text-gray-700" v-if="event.agent_name">
                                        {{ event.agent_name }}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Event Data Visualization -->
                            <div class="text-sm font-mono bg-gray-50 p-2 rounded overflow-x-auto whitespace-pre-wrap text-gray-600">
                                {{ formatData(event.type, event.data) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                <div class="text-center">
                    <div class="text-4xl mb-4">ðŸ§µ</div>
                    <p>Select a trace from the sidebar to visualize execution.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue

        createApp({
            setup() {
                const traces = ref([])
                const currentTrace = ref(null)
                
                const fetchTraces = async () => {
                    try {
                        const res = await fetch('/api/traces?limit=20')
                        traces.value = await res.json()
                    } catch (e) {
                        console.error(e)
                    }
                }

                const selectTrace = async (trace) => {
                    try {
                        const res = await fetch(`/api/traces/${trace.id}`)
                        currentTrace.value = await res.json()
                    } catch (e) {
                        console.error(e)
                    }
                }
                
                const refreshCurrentTrace = () => {
                   if (currentTrace.value) {
                       selectTrace({id: currentTrace.value.id})
                   }
                }

                const formatDate = (ts) => {
                    // Python timestamp might be string or float
                    return new Date(ts).toLocaleString()
                }

                const formatTime = (ts) => {
                    const d = new Date(ts * 1000) // Assuming float seconds
                    return d.toLocaleTimeString() + '.' + d.getMilliseconds()
                }

                const getStatusClass = (status) => {
                    return status === 'running' ? 'text-blue-500' : 'text-green-500'
                }

                const getEventColor = (type) => {
                    if (type.includes('error')) return 'bg-red-500'
                    if (type.includes('start')) return 'bg-blue-500'
                    if (type.includes('end')) return 'bg-green-500'
                    return 'bg-gray-400'
                }

                const getEventBadgeClass = (type) => {
                    if (type.includes('error')) return 'bg-red-100 text-red-800'
                    if (type.includes('start')) return 'bg-blue-100 text-blue-800'
                    if (type.includes('end')) return 'bg-green-100 text-green-800'
                    return 'bg-gray-100 text-gray-800'
                }

                const formatData = (type, data) => {
                    // Visualize specific event types better
                    if (!data) return ''
                    
                    if (type === 'llm_stream_chunk') return data.chunk
                    
                    if (type.includes('tool')) {
                        if (data.args) return `Args: ${JSON.stringify(data.args, null, 2)}`
                        if (data.result) return `Result: ${data.result}`
                    }
                    
                    if (type === 'agent_start') {
                         return `Input: ${data.input || data.message || ''}`
                    }
                    
                    if (type === 'agent_end') {
                         return `Output: ${data.output || data.message || ''}`
                    }
                    
                    return JSON.stringify(data, null, 2)
                }

                onMounted(() => {
                    fetchTraces()
                })

                return {
                    traces,
                    currentTrace,
                    fetchTraces,
                    selectTrace,
                    refreshCurrentTrace,
                    formatDate,
                    formatTime,
                    getStatusClass,
                    getEventColor,
                    getEventBadgeClass,
                    formatData
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
