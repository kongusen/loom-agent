name: Sync Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'wiki/**'
      - '.github/workflows/sync-wiki.yml'
    tags:
      - 'v*.*.*'  # åœ¨å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ä¹ŸåŒæ­¥ Wiki
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: Checkout wiki repo
        id: checkout_wiki
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          repository: kongusen/loom-agent.wiki
          path: wiki_repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create wiki repo if not exists
        if: steps.checkout_wiki.outcome == 'failure'
        run: |
          echo "âš ï¸ Wiki ä»“åº“ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–"
          echo "è¯·è®¿é—® https://github.com/kongusen/loom-agent/wiki"
          echo "ç‚¹å‡» 'Add a new page' åˆ›å»ºç¬¬ä¸€ä¸ªé¡µé¢"
          echo "ç„¶åé‡æ–°è¿è¡Œæ­¤ workflow"
          exit 1

      - name: Copy Wiki files
        run: |
          # å¤åˆ¶æ‰€æœ‰ Wiki æ–‡ä»¶
          cp -r main_repo/wiki/* wiki_repo/

          # åˆ—å‡ºå¤åˆ¶çš„æ–‡ä»¶
          echo "ğŸ“„ å¤åˆ¶çš„æ–‡ä»¶:"
          ls -la wiki_repo/

      - name: Configure Git
        run: |
          cd wiki_repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Check for changes
        id: check_changes
        run: |
          cd wiki_repo
          if git diff --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ£€æµ‹åˆ°æ›´æ”¹"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          cd wiki_repo
          git add .
          git commit -m "docs: sync Wiki from main repo

          è‡ªåŠ¨ä»ä¸»ä»“åº“åŒæ­¥ Wiki æ–‡æ¡£
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}

          ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"
          git push

      - name: Summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… Wiki åŒæ­¥æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®: https://github.com/kongusen/loom-agent/wiki"
